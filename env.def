Bootstrap: docker
From: ubuntu:22.04

%post
    # Prevent systemd conflicts
    export DEBIAN_FRONTEND=noninteractive

    # Update and install essential dependencies
    apt-get update
    apt-get install -y --no-install-recommends cmake build-essential wget curl libssl-dev libcurl4-openssl-dev libxml2-dev zlib1g-dev
    apt-get install -y --no-install-recommends lsb-release gnupg
    apt-get install -y --no-install-recommends ca-certificates git locales libgsl-dev python3-pip
    apt-get install -y python3-tk
    apt-get install -y --no-install-recommends \
        xvfb \
        xauth \
        xfonts-base \
        tk-dev \
        libx11-dev \
        libxt-dev



    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

    echo "export LC_ALL=en_US.UTF-8" >> /etc/profile
    echo "export LANG=en_US.UTF-8" >> /etc/profile

    # Install Python 3.11
    echo "deb http://ppa.launchpad.net/deadsnakes/ppa/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/deadsnakes-ppa.list && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA6932366A755776 && \
    apt-get update && apt-get install -y --no-install-recommends python3.11 python3.11-venv python3.11-dev

    # Remove any existing python3 symlink
    if [ -L /usr/bin/python3 ]; then
        rm /usr/bin/python3
    fi

    # Create a symbolic link for python3 to python3.11
    ln -s /usr/bin/python3.11 /usr/bin/python3
    
    # Install R 4.4.1
    wget --no-check-certificate https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc && \
    gpg --dearmor -o /usr/share/keyrings/cran.gpg marutter_pubkey.asc && \
    echo "deb [signed-by=/usr/share/keyrings/cran.gpg] https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -sc)-cran40/" > /etc/apt/sources.list.d/cran.list && \
    apt-get update && apt-get install -y --no-install-recommends r-base


    apt-get install -y --no-install-recommends gcc nano cmake gfortran liblapack-dev libblas-dev tcl tk x11-xserver-utils libfontconfig1-dev libfreetype6-dev pkg-config libgsl-dev

    apt-get install -y --no-install-recommends libharfbuzz-dev libfribidi-dev libfreetype6-dev

    apt-get update && apt-get install -y libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev pkg-config
    
    # Clean up
    apt-get clean && rm -rf /var/lib/apt/lists/*

%files
    renv.lock /app/renv.lock
    requirements.txt /app/requirements.txt

%environment
    export PATH="/usr/local/bin:/usr/bin:/bin:/usr/lib/R/bin:/opt/python3.11/bin:$PATH"
    export DISPLAY=:99


%runscript
    # Ensure both Python and R are available in the PATH
    export PATH="/usr/bin/python3.11:$PATH"
    export PATH="/usr/lib/R/bin:$PATH"
    # Start virtual X server
    Xvfb :99 -screen 0 1024x768x24 &
    sleep 2  # Give Xvfb time to start
    exec "$@"  # Execute the command passed to the container


%startscript
    # Start virtual X server
    Xvfb :99 -screen 0 1024x768x24 &
    sleep 2  # Give Xvfb time to start
    echo "Running renv::restore()..."
    R -e "renv::restore()"
