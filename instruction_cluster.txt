### EULER

module load stack/.2024-06-silent
module load stack/2024-06
module load gcc/12.2.0 r/4.4.0
module load stack/2024-06 curl/8.4.0-s6dtj75
module load stack/2024-06 openssl/3.1.3-zhfub4o
module load stack/2024-06 zlib/1.3-mktm5vz
module load stack/2024-06 cmake/3.27.7
module load stack/2024-06 tk/8.6.11-fflzonm

Xvfb :99 -screen 0 1024x768x16 &
export DISPLAY=:99

module load stack/2024-06 libfontenc/1.1.7-hs357sj
module load stack/2024-06 pkgconf/1.9.5-ju7uckx
module load stack/2024-06 fontconfig/2.13.1-b4vx4ls
module load stack/2024-06 freetype/2.11.1-fy5fkou

R 

=> start interactive, install packages

Sys.setenv(GITHUB_PAT = "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")
renv::restore()


################## NEF
ssh -i ~/.ssh/chmuller chmuller@nef-frontal.inria.fr
ssh chmuller@nef-devel.inria.fr


Bootstrap: docker
From: ubuntu:22.04

%post
    # Prevent systemd conflicts
    export DEBIAN_FRONTEND=noninteractive

    # Update and install essential dependencies
    apt-get update
    apt-get install -y --no-install-recommends build-essential wget curl libssl-dev libcurl4-openssl-dev libxml2-dev zlib1g-dev
    apt-get install -y --no-install-recommends lsb-release gnupg
    apt-get install -y --no-install-recommends ca-certificates git locales libgsl-dev python3-pip

    # Install Python 3.11
    echo "deb http://ppa.launchpad.net/deadsnakes/ppa/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/deadsnakes-ppa.list && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA6932366A755776 && \
    apt-get update && apt-get install -y --no-install-recommends python3.11 python3.11-venv python3.11-dev

    # Remove any existing python3 symlink
    if [ -L /usr/bin/python3 ]; then
        rm /usr/bin/python3
    fi

    # Create a symbolic link for python3 to python3.11
    ln -s /usr/bin/python3.11 /usr/bin/python3
    
    # Install R 4.4.1
    wget --no-check-certificate https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc && \
    gpg --dearmor -o /usr/share/keyrings/cran.gpg marutter_pubkey.asc && \
    echo "deb [signed-by=/usr/share/keyrings/cran.gpg] https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -sc)-cran40/" > /etc/apt/sources.list.d/cran.list && \
    apt-get update && apt-get install -y --no-install-recommends r-base


    apt-get install -y --no-install-recommends gcc nano cmake gfortran liblapack-dev libblas-dev tcl tk x11-xserver-utils libfontconfig1-dev libfreetype6-dev pkg-config libgsl-dev

    apt-get install -y --no-install-recommends libharfbuzz-dev libfribidi-dev libfreetype6-dev

    apt-get update && apt-get install -y libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev pkg-config
    
    # Clean up
    apt-get clean && rm -rf /var/lib/apt/lists/*

%files
    renv.lock /app/renv.lock
    requirements.txt /app/requirements.txt

%environment
    export PATH="/usr/local/bin:/usr/bin:/bin:/usr/lib/R/bin:/opt/python3.11/bin:$PATH"

%runscript
    # Ensure both Python and R are available in the PATH
    export PATH="/usr/bin/python3.11:$PATH"
    export PATH="/usr/lib/R/bin:$PATH"
    exec "$@"  # Execute the command passed to the container (e.g., python, R)

%startscript
    echo "Running renv::restore()..."
    R -e "renv::restore()"



Xvfb :99 -screen 0 1024x768x16 &
export DISPLAY=:99


R =>

TRY THIS:
    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

    echo "export LC_ALL=en_US.UTF-8" >> /etc/profile
    echo "export LANG=en_US.UTF-8" >> /etc/profile

Sys.setenv(GITHUB_PAT = "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")
Sys.setenv(R_COMPILE_AND_INSTALL_PACKAGES = "never")# => to install NMF
devtools::install_github("renozao/pkgmaker")

renv::restore()



## step by step:

(being in .venv)
* Create apptainer, install targets, empty _targets.R, remove python import, ... => WORKS
* import most R packages, empty pipeline => WORKS
* Add all steps before list pipeline => WORKS
* uncomment tar_option_set (python path) => WORKS 
* add in pipeline: all (but python file still commented out) => WORKS, needed to add directory "results/xx"
* install imputomics => WORKS (no python yet)
* use renv::restore ==> DOES NOT WORK ANYMMORE ????