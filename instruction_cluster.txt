### EULER

Create same apptainer container as below
mkdir -p /tmp/R/renv/cache
export R_USER_CACHE_DIR=/tmp/R
export RENV_PATHS_CACHE=/tmp/R/renv/cache
export RENV_PATHS_LIBRARY=/tmp/R/renv/library

Xvfb :99 -screen 0 1024x768x24 &

renv::...


install.packages(pkgs="https://cran.r-project.org/src/contrib/Archive/TimeProjection/TimeProjection_0.2.0.tar.gz", type="source", repos=NULL)




################## NEF
ssh -i ~/.ssh/chmuller chmuller@nef-frontal.inria.fr
ssh chmuller@nef-devel.inria.fr


Bootstrap: docker
From: ubuntu:22.04

%post
    # Prevent systemd conflicts
    export DEBIAN_FRONTEND=noninteractive

    # Update and install essential dependencies
    apt-get update
    apt-get install -y --no-install-recommends cmake build-essential wget curl libssl-dev libcurl4-openssl-dev libxml2-dev zlib1g-dev
    apt-get install -y --no-install-recommends lsb-release gnupg
    apt-get install -y --no-install-recommends ca-certificates git locales libgsl-dev python3-pip
    apt-get install -y python3-tk

    locale-gen en_US.UTF-8
    update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

    echo "export LC_ALL=en_US.UTF-8" >> /etc/profile
    echo "export LANG=en_US.UTF-8" >> /etc/profile

    # Install Python 3.11
    echo "deb http://ppa.launchpad.net/deadsnakes/ppa/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/deadsnakes-ppa.list && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA6932366A755776 && \
    apt-get update && apt-get install -y --no-install-recommends python3.11 python3.11-venv python3.11-dev

    # Remove any existing python3 symlink
    if [ -L /usr/bin/python3 ]; then
        rm /usr/bin/python3
    fi

    # Create a symbolic link for python3 to python3.11
    ln -s /usr/bin/python3.11 /usr/bin/python3
    
    # Install R 4.4.1
    wget --no-check-certificate https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc && \
    gpg --dearmor -o /usr/share/keyrings/cran.gpg marutter_pubkey.asc && \
    echo "deb [signed-by=/usr/share/keyrings/cran.gpg] https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -sc)-cran40/" > /etc/apt/sources.list.d/cran.list && \
    apt-get update && apt-get install -y --no-install-recommends r-base


    apt-get install -y --no-install-recommends gcc nano cmake gfortran liblapack-dev libblas-dev tcl tk x11-xserver-utils libfontconfig1-dev libfreetype6-dev pkg-config libgsl-dev

    apt-get install -y --no-install-recommends libharfbuzz-dev libfribidi-dev libfreetype6-dev

    apt-get update && apt-get install -y libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev pkg-config
    
    # Clean up
    apt-get clean && rm -rf /var/lib/apt/lists/*

%files
    renv.lock /app/renv.lock
    requirements.txt /app/requirements.txt

%environment
    export PATH="/usr/local/bin:/usr/bin:/bin:/usr/lib/R/bin:/opt/python3.11/bin:$PATH"

%runscript
    # Ensure both Python and R are available in the PATH
    export PATH="/usr/bin/python3.11:$PATH"
    export PATH="/usr/lib/R/bin:$PATH"
    exec "$@"  # Execute the command passed to the container (e.g., python, R)

%startscript
    echo "Running renv::restore()..."
    R -e "renv::restore()"



Xvfb :99 -screen 0 1024x768x16 &
export DISPLAY=:99


R =>

Sys.setenv(GITHUB_PAT = "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")
Sys.setenv(R_COMPILE_AND_INSTALL_PACKAGES = "never")# => to install NMF
devtools::install_github("renozao/pkgmaker")

renv::restore()



## step by step:

(being in .venv)
* Create apptainer, install targets, empty _targets.R, remove python import, ... => WORKS
* import most R packages, empty pipeline => WORKS
* Add all steps before list pipeline => WORKS
* uncomment tar_option_set (python path) => WORKS 
* add in pipeline: all (but python file still commented out) => WORKS, needed to add directory "results/xx"
* install imputomics => WORKS (no python yet)
* use renv::restore ==> DOES NOT WORK ANYMMORE ????


TODO:
* Add on git subfolder results/amputed results/imputed
* Add miceDRF (uncomment it everywhere)
* Add python (reticulate path + uncomment file)



ALTOGETHER:
oarsub -l nodes=1/core=16 -n first_attempt_code --stdout output/targets_output.log --stderr output/targets_error.log "singularity exec env.sif Rscript run.R"
oarstat
oardel [job_id]
oarhold [job_id]
oarresume [job_id]